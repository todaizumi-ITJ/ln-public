<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å®Ÿç¸¾ãƒ»ãƒ¬ãƒ™ãƒ« â€” LNãƒãƒ¼ã‚¿ãƒ«</title>
  <style>
    :root {
      --font: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      --ink: #1f2937; --muted: #6b7280; --faint: #9ca3af;
      --surface: #ffffff; --surface2: #f9fafb; --border: #e5e7eb;
      --blue: #2563eb; --blue-bg: #eff6ff;
      --green: #059669; --green-bg: #ecfdf5;
      --yellow: #d97706; --yellow-bg: #fffbeb;
      --red: #dc2626; --red-bg: #fef2f2;
      --purple: #7e3af2; --purple-bg: #f5f3ff;
      --bg: #f9fafb; --sidebar-bg: #ffffff; --accent: #2563eb;
      --amber: #d97706; --amber-bg: #fffbeb;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font); background-color: var(--surface2); color: var(--ink); margin: 0; min-height: 100vh; }

    /* ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ - å›ºå®šä½ç½® */
    .back-to-portal {
      position: fixed;
      z-index: 9999;
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    .back-to-portal:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.6);
      text-decoration: none;
    }
    .back-to-portal-top-left {
      top: 20px;
      left: 20px;
    }
    .back-to-portal-top-right {
      top: 20px;
      right: 20px;
    }
    .back-to-portal-bottom-left {
      bottom: 20px;
      left: 20px;
    }
    .back-to-portal-bottom-right {
      bottom: 20px;
      right: 20px;
    }
    @media (max-width: 768px) {
      .back-to-portal {
        padding: 10px 16px;
        font-size: 12px;
      }
      .back-to-portal-top-left,
      .back-to-portal-bottom-left {
        left: 10px;
      }
      .back-to-portal-top-right,
      .back-to-portal-bottom-right {
        right: 10px;
      }
    }

    /* Header */
    .game-header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    .game-header-title { font-size: 18px; font-weight: 800; letter-spacing: -0.3px; }
    .game-header .back-link { font-size: 13px; color: var(--blue); text-decoration: none; font-weight: 600; }
    .game-header .back-link:hover { text-decoration: underline; }
    .game-header-right { display: flex; align-items: center; gap: 16px; }

    /* Container */
    .game-container { max-width: 1100px; margin: 0 auto; padding: 24px; }

    /* Tabs */
    .game-tabs { display: flex; gap: 4px; margin-bottom: 24px; flex-wrap: wrap; }
    .game-tab {
      padding: 10px 18px; font-size: 13px; font-weight: 600; border-radius: 8px;
      border: 1px solid var(--border); background: var(--surface2); cursor: pointer;
      color: var(--muted); transition: all 0.2s;
    }
    .game-tab:hover { background: var(--border); color: var(--ink); }
    .game-tab.active { background: var(--purple); color: white; border-color: var(--purple); }

    /* Cards */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .card-head { padding: 18px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .card-title { font-size: 16px; font-weight: 700; }
    .card-body { padding: 20px 24px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; border: 1px solid var(--border); cursor: pointer; transition: all 0.15s; font-family: var(--font); }
    .btn-primary { background: var(--blue); color: white; border-color: var(--blue); }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background: var(--surface2); color: var(--ink); }
    .btn-secondary:hover { background: var(--border); }

    /* Game panels */
    .game-panel { display: none; }
    .game-panel.active { display: block; }

    /* Report styles */
    .report-clear-banner {
      background: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 50%, #ec4899 100%);
      color: white; text-align: center; padding: 24px; border-radius: 16px;
      margin-bottom: 24px; box-shadow: 0 8px 32px rgba(14,165,233,0.3);
    }
    .report-clear-banner h2 { font-size: 24px; margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .report-clear-banner .report-date { font-size: 13px; opacity: 0.9; }
    .report-total-score { font-size: 48px; font-weight: 800; margin: 16px 0 8px; text-shadow: 0 2px 8px rgba(0,0,0,0.2); font-family: monospace; }
    .report-rank { font-size: 14px; font-weight: 600; letter-spacing: 0.1em; }
    .report-role-card { background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    .report-role-card.beginner { border-left: 5px solid var(--green); }
    .report-role-card.expert { border-left: 5px solid var(--blue); }
    .report-role-card.leader { border-left: 5px solid var(--purple); }
    .report-role-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .report-role-title { font-size: 16px; font-weight: 700; }
    .report-role-points { font-size: 24px; font-weight: 800; font-family: monospace; }
    .report-role-card.beginner .report-role-points { color: var(--green); }
    .report-role-card.expert .report-role-points { color: var(--blue); }
    .report-role-card.leader .report-role-points { color: var(--purple); }
    .report-task-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; margin-bottom: 6px; background: var(--surface2); border-radius: 8px; font-size: 13px; }
    .report-task-item .task-ok { color: var(--green); font-size: 16px; }
    .report-task-item .task-point { font-weight: 700; font-family: monospace; font-size: 12px; color: var(--muted); margin-left: auto; }
    .report-empty { color: var(--faint); font-style: italic; padding: 16px; }

    /* Leaderboard styles */
    .leaderboard-stat-card { background: var(--surface); border-radius: 12px; padding: 20px; border: 1px solid var(--border); text-align: center; }
    .leaderboard-stat-val { font-size: 28px; font-weight: 800; font-family: monospace; }
    .leaderboard-stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .leaderboard-member-card { background: var(--surface); border-radius: 12px; padding: 20px; border: 1px solid var(--border); transition: all 0.2s; }
    .leaderboard-member-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

    /* Level & Promotion overview */
    .level-overview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    @media (max-width: 700px) { .level-overview-grid { grid-template-columns: 1fr; } }

    /* Welcome stats */
    .welcome-stats { display: flex; flex-wrap: wrap; gap: 10px; }
    .welcome-stat { background: var(--surface); border-radius: 12px; padding: 14px 12px; text-align: center; border: 1px solid var(--border); transition: transform 0.2s; }
    .welcome-stat:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .welcome-stat-val { font-size: 24px; font-weight: 800; font-family: monospace; }
    .welcome-stat-label { font-size: 10px; color: var(--muted); margin-top: 6px; font-weight: 500; }

    /* Expert path */
    .expert-path-list { display: flex; flex-wrap: wrap; gap: 10px; }
    .expert-path-item { display: inline-flex; align-items: center; gap: 6px; font-size: 11px; padding: 8px 12px; background: var(--surface2); border-radius: 20px; border: 1px solid var(--border); }
    .expert-path-item.done { background: var(--green-bg); border-color: rgba(34,197,94,0.3); color: var(--green); font-weight: 600; }
    .expert-path-item:not(.done) { color: var(--muted); }

    /* User selector */
    .user-select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; font-family: var(--font); background: var(--surface); }
    
    /* Report save button */
    .save-report-btn:hover { background: #059669 !important; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .save-report-btn:active { transform: translateY(0); }
    
    /* è¦ç´ ç•ªå·ãƒãƒƒã‚¸ */
    .element-id {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      font-family: monospace;
      color: #9ca3af;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 2px 5px;
      margin-left: 6px;
      vertical-align: middle;
      cursor: help;
      transition: all 0.2s;
    }
    .element-id:hover {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      transform: scale(1.1);
    }
  </style>
</head>
<body>
  <!-- ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆ4ç®‡æ‰€ï¼‰ -->
  <a href="lnportal.html" class="back-to-portal back-to-portal-top-left">â† ãƒãƒ¼ã‚¿ãƒ«</a>
  <a href="lnportal.html" class="back-to-portal back-to-portal-top-right">ãƒãƒ¼ã‚¿ãƒ« â†’</a>
  <a href="lnportal.html" class="back-to-portal back-to-portal-bottom-left">â† ãƒãƒ¼ã‚¿ãƒ«</a>
  <a href="lnportal.html" class="back-to-portal back-to-portal-bottom-right">ãƒãƒ¼ã‚¿ãƒ« â†’</a>

<div class="game-header">
  <span class="game-header-title">ğŸ® å®Ÿç¸¾ãƒ»ãƒ¬ãƒ™ãƒ«</span>
  <div class="game-header-right">
    <select id="user-select" class="user-select" onchange="setUser(this.value)"></select>
    <a href="lnportal.html" class="back-link">â† ãƒãƒ¼ã‚¿ãƒ«ã«æˆ»ã‚‹</a>
  </div>
</div>

<div class="game-container">
  <div class="game-tabs">
    <button class="game-tab active" data-panel="overview" onclick="showGamePanel('overview')">ğŸ“Š ãƒã‚¤ãƒšãƒ¼ã‚¸<span class="element-id" title="è¦ç´ ID: G-01">G-01</span></button>
    <button class="game-tab" data-panel="report" onclick="showGamePanel('report')">ğŸ“‹ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ<span class="element-id" title="è¦ç´ ID: G-02">G-02</span></button>
    <button class="game-tab" data-panel="leaderboard" onclick="showGamePanel('leaderboard')">ğŸ† ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰<span class="element-id" title="è¦ç´ ID: G-03">G-03</span></button>
  </div>

  <!-- ========== ãƒã‚¤ãƒšãƒ¼ã‚¸ ========== -->
  <div id="game-panel-overview" class="game-panel active">
    <div class="level-overview-grid">
      <div class="card">
        <div class="card-head"><span class="card-title">ğŸ“Š ãƒ¬ãƒ™ãƒ«ãƒ»çµŒé¨“å€¤</span></div>
        <div class="card-body" id="overview-level-bar"></div>
      </div>
      <div class="card">
        <div class="card-head"><span class="card-title">ğŸ† æ˜‡æ ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</span></div>
        <div class="card-body" id="overview-promotion-card"></div>
      </div>
    </div>
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-head"><span class="card-title">ğŸ“Š ä»Šæœˆã®æˆç¸¾</span></div>
      <div class="card-body">
        <div class="welcome-stats" id="overview-stats"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head"><span class="card-title">ğŸ—ºï¸ ã‚¹ã‚­ãƒ«ãƒ‘ã‚¹</span></div>
      <div class="card-body">
        <p style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">â‘ ä½œæ¥­ â†’ â‘¡+pt â†’ â‘¢ã‚¹ã‚­ãƒ« â†’ â‘£ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</p>
        <div class="expert-path-list" id="overview-path-list"></div>
      </div>
    </div>
  </div>

  <!-- ========== æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ ========== -->
  <div id="game-panel-report" class="game-panel">
    
    <!-- æœ¬æ—¥ã®å ±å‘Šè¨˜å…¥æ¬„ -->
    <div class="card" style="margin-bottom: 20px; border: 2px solid var(--blue);">
      <div class="card-head" style="background: var(--blue-bg);">
        <span class="card-title">âœï¸ æœ¬æ—¥ã®æ¥­å‹™å ±å‘Š</span>
        <button onclick="saveReport()" class="save-report-btn" style="background:#10b981;color:white;border:none;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s">ğŸ’¾ ä¿å­˜</button>
      </div>
      <div class="card-body">
        <div style="margin-bottom: 16px;">
          <label style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary)">ğŸ“ ä»Šæ—¥ã®ä½œæ¥­å†…å®¹</label>
          <textarea id="report-work-content" placeholder="ä»Šæ—¥å®Ÿæ–½ã—ãŸä½œæ¥­ã®è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹: LN 7K14488ã®ç”³ç«‹æ›¸ä½œæˆå®Œäº†ã€è¨¼æ‹ èª¬æ˜æ›¸ã‚’è‡ªå‹•ç”Ÿæˆ" style="width:100%;min-height:120px;padding:12px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;line-height:1.6;resize:vertical"></textarea>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label style="display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:var(--text-primary)">ğŸ“¢ ä¼é”äº‹é …ï¼ˆå…±æœ‰ã—ãŸã„ã“ã¨ï¼‰</label>
          <textarea id="report-message" placeholder="ãƒãƒ¼ãƒ ã¸ã®é€£çµ¡ã€è³ªå•ã€ç›¸è«‡äº‹é …ãªã©ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚&#10;ä¾‹: å§”ä»»çŠ¶ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œãã†ãªLNãŒ3ä»¶ã‚ã‚Šã¾ã™ã€‚å¯¾å¿œæ–¹æ³•ã‚’ã”ç›¸è«‡ã—ãŸã„ã§ã™ã€‚" style="width:100%;min-height:100px;padding:12px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;line-height:1.6;resize:vertical"></textarea>
        </div>
        
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--surface2);border-radius:8px;font-size:11px;color:var(--muted)">
          <span id="report-save-status">ğŸ’¡ è¨˜å…¥å¾Œã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„</span>
          <span id="report-last-saved" style="font-weight:600"></span>
        </div>
      </div>
    </div>
    
    <div class="report-clear-banner">
      <h2>ğŸ‰ æœ¬æ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ ã‚¯ãƒªã‚¢ï¼</h2>
      <p class="report-date" id="report-date"></p>
      <div class="report-total-score" id="report-total-score">0</div>
      <div class="report-rank" id="report-rank">â€”</div>
    </div>
    <div id="report-body"></div>
  </div>

  <!-- ========== ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ ========== -->
  <div id="game-panel-leaderboard" class="game-panel">
    <div class="card">
      <div class="card-head" style="background: var(--purple-bg);">
        <span class="card-title">ğŸ† ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ â€” ãƒ¡ãƒ³ãƒãƒ¼æ¥­å‹™çŠ¶æ³</span>
        <span style="font-size: 12px; color: var(--muted);">ä»Šæ—¥ã®æ¥­å‹™ã‚¿ã‚¹ã‚¯ãƒ»ç¾åœ¨ã®é€²æ—ãƒ»å®Œæˆã—ãŸã“ã¨ã‚’ä¸€è¦§</span>
      </div>
      <div class="card-body">
        <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:24px" id="leaderboard-summary"></div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px" id="leaderboard-member-grid"></div>
      </div>
    </div>
  </div>
</div>

<script src="db_case.js"></script>
<script src="db_game.js"></script>
<script>
  // ===== ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åˆæˆ =====
  USERS.forEach(u => {
    const g = USER_GAME_DATA[u.id];
    if (g) { u.level = g.level; u.totalPt = g.totalPt; u.title = g.title; }
  });
  const dailyReportData = actionLog;

  let currentUser = USERS[0];
  let currentRole = 'beginner';

  // ===== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ =====
  const urlParams = new URLSearchParams(window.location.search);
  const initialPanel = urlParams.get('panel') || 'overview';
  const initialUser = urlParams.get('user');

  // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒ¬ã‚¯ã‚¿åˆæœŸåŒ– =====
  function initUserSelect() {
    const sel = document.getElementById('user-select');
    if (!sel) return;
    sel.innerHTML = USERS.map(u => {
      const roleIcon = {beginner:'ğŸ›¡ï¸',expert:'âš”ï¸',leader:'ğŸ°'};
      return '<option value="'+u.id+'">'+(roleIcon[u.role]||'ğŸ›¡ï¸')+' '+u.name+' ('+u.role+')</option>';
    }).join('');
  }

  // ===== ãƒ‘ãƒãƒ«åˆ‡æ›¿ =====
  function showGamePanel(id) {
    document.querySelectorAll('.game-panel').forEach(p => p.classList.remove('active'));
    const panel = document.getElementById('game-panel-' + id);
    if (panel) panel.classList.add('active');
    document.querySelectorAll('.game-tab').forEach(t => t.classList.toggle('active', t.dataset.panel === id));
    if (id === 'report') updateReportPanel();
    if (id === 'leaderboard') updateLeaderboardPanel();
    if (id === 'overview') updateOverview();
  }

  // ===== ãƒ¬ãƒ™ãƒ«è¨ˆç®— =====
  function getLevelInfo(totalPt) {
    let lv = LEVEL_TABLE[0];
    for (const l of LEVEL_TABLE) { if (totalPt >= l.minPt) lv = l; }
    const nextLv = LEVEL_TABLE.find(l => l.minPt > totalPt);
    return { ...lv, nextPt: nextLv ? nextLv.minPt : null, pct: nextLv ? Math.round((totalPt - lv.minPt) / (nextLv.minPt - lv.minPt) * 100) : 100 };
  }

  // ===== æ˜‡æ ¼é€²æ— =====
  function getPromotionProgress(userId) {
    const pd = PROMOTION_DATA[userId];
    if (!pd) return null;
    const done = pd.conditions.filter(c => c.done).length;
    return { ...pd, doneCount: done, totalCount: pd.conditions.length, pct: Math.round(done / pd.conditions.length * 100) };
  }

  // ===== ãƒ¬ãƒ™ãƒ«ãƒãƒ¼æç”» =====
  function renderLevelBar(user) {
    const li = getLevelInfo(user.totalPt);
    const roleIcon = {beginner:'ğŸ›¡ï¸',expert:'âš”ï¸',leader:'ğŸ°'}[user.role]||'ğŸ›¡ï¸';
    let h = '<div style="display:flex;align-items:center;gap:10px;padding:8px 0">';
    h += '<span style="font-size:20px">'+roleIcon+'</span>';
    h += '<div style="flex:1">';
    h += '<div style="display:flex;align-items:baseline;gap:6px;margin-bottom:4px">';
    h += '<span style="font-size:13px;font-weight:800">Lv.'+li.level+'</span>';
    h += '<span style="font-size:11px;color:var(--muted)">'+li.title+'</span>';
    h += '<span style="font-size:10px;color:var(--muted);margin-left:auto">'+user.totalPt+(li.nextPt?'/'+li.nextPt:'')+'pt</span>';
    h += '</div>';
    h += '<div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden">';
    h += '<div style="height:100%;width:'+li.pct+'%;background:linear-gradient(90deg,var(--green),var(--blue));border-radius:3px;transition:width 0.3s"></div>';
    h += '</div></div></div>';
    return h;
  }

  // ===== æ˜‡æ ¼ã‚«ãƒ¼ãƒ‰æç”» =====
  function renderPromotionCard(userId) {
    const pp = getPromotionProgress(userId);
    if (!pp) return '<div style="color:var(--muted);font-size:12px;padding:16px">ğŸ° æœ€é«˜ãƒ­ãƒ¼ãƒ«åˆ°é”æ¸ˆã¿</div>';
    const roleIcon = {beginner:'ğŸ›¡ï¸',expert:'âš”ï¸',leader:'ğŸ°'};
    let h = '<div>';
    h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">';
    h += '<span style="font-size:16px">'+roleIcon[pp.from]+'â†’'+roleIcon[pp.to]+'</span>';
    h += '<span style="font-size:13px;font-weight:700">'+pp.to.charAt(0).toUpperCase()+pp.to.slice(1)+' æ˜‡æ ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</span>';
    h += '<span style="font-size:11px;font-weight:700;padding:2px 10px;border-radius:100px;background:'+(pp.pct>=80?'var(--green-bg)':'var(--amber-bg)')+';color:'+(pp.pct>=80?'var(--green)':'var(--amber)')+'">'+pp.pct+'%</span>';
    h += '</div>';
    pp.conditions.forEach(c => {
      const pct = c.done ? 100 : Math.min(99, Math.round(c.current / c.target * 100));
      h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:12px">';
      h += '<span style="font-size:14px">'+(c.done?'âœ…':'â¬œ')+'</span>';
      h += '<span style="flex:1;color:'+(c.done?'var(--green)':'var(--text)')+'">'+c.label+'</span>';
      h += '<span style="font-size:11px;color:var(--muted);min-width:60px;text-align:right">'+c.current+'/'+(c.unit||'')+c.target+'</span>';
      h += '</div>';
      if (!c.done) {
        h += '<div style="margin:0 0 8px 22px;height:4px;background:var(--surface2);border-radius:2px;overflow:hidden">';
        h += '<div style="height:100%;width:'+pct+'%;background:var(--blue);border-radius:2px;transition:width 0.3s"></div></div>';
      }
    });
    h += '</div>';
    return h;
  }

  // ===== ãƒã‚¤ãƒšãƒ¼ã‚¸æ›´æ–° =====
  function updateOverview() {
    const lvBar = document.getElementById('overview-level-bar');
    if (lvBar) lvBar.innerHTML = renderLevelBar(currentUser);
    const promoCard = document.getElementById('overview-promotion-card');
    if (promoCard) promoCard.innerHTML = renderPromotionCard(currentUser.id);

    const rv = ROLE_VIEW[currentRole] || ROLE_VIEW.beginner;
    const statsEl = document.getElementById('overview-stats');
    if (statsEl && rv.stats) {
      statsEl.innerHTML = rv.stats.map(s =>
        '<div class="welcome-stat"><div class="welcome-stat-val" style="color:'+rv.welcomeColor+'">'+s.val+'</div><div class="welcome-stat-label">'+s.label+'</div></div>'
      ).join('');
    }
    const pathEl = document.getElementById('overview-path-list');
    if (pathEl && rv.expertPath) {
      pathEl.innerHTML = rv.expertPath.map(p =>
        '<span class="expert-path-item '+(p.done?'done':'')+'"><span>'+(p.done?'âœ“':'â—‹')+'</span>'+p.text+'</span>'
      ).join('');
    }
  }

  // ===== æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ =====
  function updateReportPanel() {
    const calc = (arr) => {
      let pt = 0;
      const items = (arr || []).map(a => {
        const p = POINTS[a.task] || 10;
        pt += p;
        let label = '';
        if (a.task === 'report') label = 'å®Œäº†å ±å‘Š';
        else if (a.task === 'ln-check') label = 'LNç¢ºèª ' + (a.extra?.ln || 'â€”');
        else label = 'æœ¬æ—¥å¯¾å¿œå®Œäº†';
        return { at: a.at, label, pt: p };
      });
      return { items, total: pt };
    };
    const fmt = (data) => {
      if (!data.items.length) return '<div class="report-empty">â€” æœªè¨˜éŒ² â€”</div>';
      return data.items.map(d =>
        '<div class="report-task-item"><span class="task-ok">âœ“</span><span>'+d.at+' '+d.label+'</span><span class="task-point">+'+d.pt+' pt</span></div>'
      ).join('');
    };
    const roleIcon = { beginner: 'ğŸ†•', expert: 'â­', leader: 'ğŸ‘”' };
    const roleLabel = { beginner: 'beginner', expert: 'expert', leader: 'leader' };

    const body = document.getElementById('report-body');
    let total = 0;
    let html = '';

    if (currentRole === 'leader') {
      USERS.forEach(u => {
        const data = calc(dailyReportData[u.id] || []);
        total += data.total;
        html += '<div class="report-role-card '+u.role+'"><div class="report-role-header"><span class="report-role-title">'+roleIcon[u.role]+' '+u.name+' <small style="opacity:0.7">('+roleLabel[u.role]+')</small></span><span class="report-role-points">'+data.total+' pt</span></div><div>'+fmt(data)+'</div></div>';
      });
    } else {
      const data = calc(dailyReportData[currentUser.id] || []);
      total = data.total;
      html = '<div class="report-role-card '+currentRole+'"><div class="report-role-header"><span class="report-role-title">'+roleIcon[currentRole]+' '+currentUser.name+' <small style="opacity:0.7">('+roleLabel[currentRole]+')</small></span><span class="report-role-points">'+data.total+' pt</span></div><div>'+fmt(data)+'</div></div>';
    }

    const rank = [...RANKS].reverse().find(r => total >= r.min)?.label || RANKS[0].label;
    body.innerHTML = html;
    document.getElementById('report-total-score').textContent = total + ' pt';
    document.getElementById('report-rank').textContent = rank;
    document.getElementById('report-date').textContent = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
    
    // ä¿å­˜ã•ã‚ŒãŸå ±å‘Šå†…å®¹ã‚’èª­ã¿è¾¼ã¿
    loadReport();
  }
  
  // ===== å ±å‘Šã®ä¿å­˜ =====
  function saveReport() {
    const workContent = document.getElementById('report-work-content').value;
    const message = document.getElementById('report-message').value;
    
    if (!workContent.trim() && !message.trim()) {
      alert('å ±å‘Šå†…å®¹ã¾ãŸã¯ä¼é”äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    const reportKey = `daily_report_${currentUser.id}_${today}`;
    
    const reportData = {
      userId: currentUser.id,
      userName: currentUser.name,
      userRole: currentUser.role,
      date: today,
      workContent: workContent,
      message: message,
      savedAt: new Date().toISOString()
    };
    
    try {
      localStorage.setItem(reportKey, JSON.stringify(reportData));
      
      // ä¿å­˜æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const statusEl = document.getElementById('report-save-status');
      const lastSavedEl = document.getElementById('report-last-saved');
      
      statusEl.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
      statusEl.style.color = 'var(--green)';
      statusEl.style.fontWeight = '600';
      
      const now = new Date();
      lastSavedEl.textContent = `æœ€çµ‚ä¿å­˜: ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      // 2ç§’å¾Œã«å…ƒã«æˆ»ã™
      setTimeout(() => {
        statusEl.textContent = 'ğŸ’¡ è¨˜å…¥å¾Œã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„';
        statusEl.style.color = 'var(--muted)';
        statusEl.style.fontWeight = 'normal';
      }, 2000);
      
      console.log('âœ“ æ—¥æ¬¡å ±å‘Šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', reportKey);
    } catch (e) {
      console.error('å ±å‘Šã®ä¿å­˜ã«å¤±æ•—:', e);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }
  
  // ===== å ±å‘Šã®èª­ã¿è¾¼ã¿ =====
  function loadReport() {
    const today = new Date().toISOString().split('T')[0];
    const reportKey = `daily_report_${currentUser.id}_${today}`;
    
    try {
      const saved = localStorage.getItem(reportKey);
      if (saved) {
        const reportData = JSON.parse(saved);
        
        document.getElementById('report-work-content').value = reportData.workContent || '';
        document.getElementById('report-message').value = reportData.message || '';
        
        const lastSavedEl = document.getElementById('report-last-saved');
        const savedDate = new Date(reportData.savedAt);
        lastSavedEl.textContent = `æœ€çµ‚ä¿å­˜: ${savedDate.getHours()}:${String(savedDate.getMinutes()).padStart(2, '0')}`;
        
        console.log('âœ“ æ—¥æ¬¡å ±å‘Šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', reportKey);
      }
    } catch (e) {
      console.error('å ±å‘Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
    }
  }

  // ===== ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰ =====
  function updateLeaderboardPanel() {
    const calc = (arr) => {
      let pt = 0;
      const tasks = {};
      (arr || []).forEach(d => {
        pt += (POINTS[d.task] || 0);
        tasks[d.task] = (tasks[d.task] || 0) + 1;
      });
      return { pt, tasks };
    };
    const summaryEl = document.getElementById('leaderboard-summary');
    const gridEl = document.getElementById('leaderboard-member-grid');
    if (!summaryEl || !gridEl) return;

    let totalPt = 0, activeCount = 0, totalFiled = 0, totalTarget = 0;
    USERS.forEach(u => {
      const r = calc(dailyReportData[u.id]);
      totalPt += r.pt;
      if (r.pt > 0) activeCount++;
      const mr = MONTHLY_RESULTS[u.id] || {};
      totalFiled += (mr.filed || 0);
      totalTarget += (mr.target || 0);
    });

    const monthName = new Date().toLocaleDateString('ja-JP', { month: 'long' });
    summaryEl.innerHTML = '<div class="leaderboard-stat-card"><div class="leaderboard-stat-val" style="color:var(--purple)">'+totalFiled+'<span style="font-size:14px;font-weight:500;color:var(--muted)"> / '+totalTarget+'</span></div><div class="leaderboard-stat-label">'+monthName+'ç”³ç«‹ å®Ÿç¸¾/ç›®æ¨™</div></div>'
      + '<div class="leaderboard-stat-card"><div class="leaderboard-stat-val" style="color:var(--green)">'+totalPt+'</div><div class="leaderboard-stat-label">ãƒãƒ¼ãƒ åˆè¨ˆ pt</div></div>'
      + '<div class="leaderboard-stat-card"><div class="leaderboard-stat-val" style="color:var(--blue)">'+activeCount+' / '+USERS.length+'</div><div class="leaderboard-stat-label">ç¨¼åƒä¸­ / äººæ•°</div></div>';

    const roleIcon = {beginner:'ğŸ›¡ï¸',expert:'âš”ï¸',leader:'ğŸ°'};
    const roleColor = {beginner:'var(--green)',expert:'var(--blue)',leader:'var(--purple)'};
    const ms = LEADERBOARD_MEMBER_STATUS;
    const sorted = [...USERS].sort((a, b) => b.level - a.level || b.totalPt - a.totalPt);

    gridEl.innerHTML = sorted.map(u => {
      const r = calc(dailyReportData[u.id]);
      const m = ms[u.id] || {};
      const li = getLevelInfo(u.totalPt);
      const pp = getPromotionProgress(u.id);
      const promoHtml = pp ? '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)"><div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:10px;color:var(--muted)">'+roleIcon[pp.from]+'â†’'+roleIcon[pp.to]+' æ˜‡æ ¼</span><span style="font-size:10px;font-weight:700;color:'+(pp.pct>=80?'var(--green)':'var(--amber)')+'">'+pp.pct+'%</span></div><div style="height:3px;background:var(--surface2);border-radius:2px;overflow:hidden"><div style="height:100%;width:'+pp.pct+'%;background:'+(pp.pct>=80?'var(--green)':'var(--amber)')+';border-radius:2px"></div></div><div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px">'+pp.conditions.map(c=>'<span style="font-size:9px;padding:1px 6px;border-radius:8px;background:'+(c.done?'var(--green-bg)':'var(--surface2)')+';color:'+(c.done?'var(--green)':'var(--muted)')+'">'+(c.done?'âœ…':'â¬œ')+c.label.split(' ')[0]+'</span>').join('')+'</div></div>' : (u.role==='leader'?'<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;color:var(--purple)">ğŸ° æœ€é«˜ãƒ­ãƒ¼ãƒ«åˆ°é”</div>':'');

      const mr = MONTHLY_RESULTS[u.id] || {filed:0,target:1};
      const mrPct = Math.round((mr.filed / mr.target) * 100);

      return '<div class="leaderboard-member-card">'
        + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">'
        + '<span style="font-size:16px">'+(roleIcon[u.role]||'ğŸ›¡ï¸')+'</span>'
        + '<div style="flex:1"><div style="font-weight:700;font-size:13px">'+u.name+'</div><div style="font-size:10px;color:var(--muted)">Lv.'+li.level+' '+li.title+' ãƒ» '+u.role+'</div></div>'
        + '<div style="text-align:right"><div style="font-size:16px;font-weight:800;color:'+(roleColor[u.role]||'var(--green)')+'">'+r.pt+'<span style="font-size:10px;font-weight:500">pt</span></div></div>'
        + '</div>'
        + '<div style="height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-bottom:8px"><div style="height:100%;width:'+li.pct+'%;background:linear-gradient(90deg,var(--green),var(--blue));border-radius:2px"></div></div>'
        + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding:4px 8px;background:'+(mrPct>=100?'#f0fdf4':'#fffbeb')+';border-radius:6px;border:1px solid '+(mrPct>=100?'#bbf7d0':'#fde68a')+'">'
        + '<span style="font-size:10px;font-weight:600;color:'+(mrPct>=100?'#15803d':'#b45309')+'">ä»Šæœˆç”³ç«‹</span>'
        + '<span style="font-size:12px;font-weight:800;color:'+(mrPct>=100?'#15803d':'#b45309')+'">'+mr.filed+' / '+mr.target+'</span>'
        + '<span style="font-size:9px;color:'+(mrPct>=100?'#15803d':'#b45309')+'">'+mrPct+'%</span></div>'
        + '<div style="font-size:10px;color:var(--muted);margin-bottom:4px">ä»Šæ—¥: '+(m.todayTasks||'â€”')+'</div>'
        + '<div style="font-size:10px;color:var(--muted)">çŠ¶æ³: '+(m.situation||'â€”')+'</div>'
        + promoHtml
        + '</div>';
    }).join('');
  }

  // ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡æ›¿ =====
  function setUser(userId) {
    const u = USERS.find(x => x.id === userId) || USERS[0];
    currentUser = u;
    currentRole = u.role;
    const sel = document.getElementById('user-select');
    if (sel) sel.value = u.id;
    // ç¾åœ¨ã®ãƒ‘ãƒãƒ«ã‚’å†æç”»
    const activePanel = document.querySelector('.game-panel.active');
    if (activePanel) {
      const id = activePanel.id.replace('game-panel-', '');
      showGamePanel(id);
    }
  }

  // ===== åˆæœŸåŒ– =====
  document.addEventListener('DOMContentLoaded', function() {
    initUserSelect();
    if (initialUser) {
      setUser(initialUser);
    } else {
      setUser(USERS[0].id);
    }
    showGamePanel(initialPanel);
  });
</script>

<!-- ========== ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½ ========== -->
<style>
.feedback-float-btn{position:fixed;bottom:24px;right:24px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none;box-shadow:0 4px 12px rgba(59,130,246,0.4);cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;z-index:9998;transition:all .3s}
.feedback-float-btn:hover{transform:scale(1.1)}
.feedback-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center}
.feedback-modal-overlay.active{display:flex}
.feedback-modal-box{background:#fff;border-radius:16px;max-width:600px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.feedback-modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px 24px 16px;border-bottom:1px solid #e5e7eb}
.feedback-modal-title{font-size:18px;font-weight:700}
.feedback-modal-close{width:32px;height:32px;border-radius:8px;border:none;background:#f3f4f6;cursor:pointer;font-size:20px}
.feedback-modal-body{padding:24px}
.feedback-form-group{margin-bottom:20px}
.feedback-form-label{display:block;font-size:13px;font-weight:600;margin-bottom:8px}
.feedback-form-select,.feedback-form-input,.feedback-form-textarea{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
.feedback-form-textarea{min-height:120px;resize:vertical}
.feedback-form-submit{width:100%;padding:14px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer}
.feedback-status{margin-top:16px;padding:12px;border-radius:8px;text-align:center;font-size:13px;font-weight:600;display:none}
.feedback-status.success{background:#d1fae5;color:#065f46}
</style>

<button class="feedback-float-btn" onclick="document.getElementById('feedbackModalOverlay').classList.add('active');document.getElementById('feedbackLocation').value=document.title.split('â€”')[0].trim()" title="ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡: G-99"><span style="font-size:24px">ğŸ’¬</span><span class="element-id" style="position:absolute;bottom:2px;right:2px;font-size:7px;padding:1px 3px;background:#fff;color:#3b82f6" title="è¦ç´ ID: G-99">G-99</span></button>

<div id="feedbackModalOverlay" class="feedback-modal-overlay" onclick="if(event.target.id==='feedbackModalOverlay')this.classList.remove('active')">
  <div class="feedback-modal-box">
    <div class="feedback-modal-header">
      <div class="feedback-modal-title">ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡</div>
      <button class="feedback-modal-close" onclick="document.getElementById('feedbackModalOverlay').classList.remove('active')">Ã—</button>
    </div>
    <div class="feedback-modal-body">
      <form onsubmit="event.preventDefault();var t=document.getElementById('feedbackType').value,l=document.getElementById('feedbackLocation').value,c=document.getElementById('feedbackContent').value.trim(),n=document.getElementById('feedbackName').value.trim();if(!c)return;var f={id:'fb_'+Date.now(),type:t,location:l||document.title,content:c,name:n||'åŒ¿å',timestamp:new Date().toISOString()};var fs=JSON.parse(localStorage.getItem('system_feedbacks')||'[]');fs.push(f);localStorage.setItem('system_feedbacks',JSON.stringify(fs));document.getElementById('feedbackStatus').className='feedback-status success';document.getElementById('feedbackStatus').textContent='âœ“ é€ä¿¡ã—ã¾ã—ãŸï¼';document.getElementById('feedbackStatus').style.display='block';setTimeout(function(){document.getElementById('feedbackModalOverlay').classList.remove('active')},2000)">
        <div class="feedback-form-group">
          <label class="feedback-form-label">ç¨®é¡</label>
          <select id="feedbackType" class="feedback-form-select" required>
            <option value="">é¸æŠ</option>
            <option value="bug">ğŸ› ãƒã‚°</option>
            <option value="improvement">ğŸ’¡ æ”¹å–„ææ¡ˆ</option>
            <option value="question">â“ è³ªå•</option>
            <option value="other">ğŸ“ ãã®ä»–</option>
          </select>
        </div>
        <div class="feedback-form-group">
          <label class="feedback-form-label">ãƒšãƒ¼ã‚¸ãƒ»æ©Ÿèƒ½å</label>
          <input type="text" id="feedbackLocation" class="feedback-form-input">
        </div>
        <div class="feedback-form-group">
          <label class="feedback-form-label">è©³ç´° *</label>
          <textarea id="feedbackContent" class="feedback-form-textarea" required></textarea>
        </div>
        <div class="feedback-form-group">
          <label class="feedback-form-label">ãŠåå‰ï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="feedbackName" class="feedback-form-input">
        </div>
        <button type="submit" class="feedback-form-submit">ğŸ“¤ é€ä¿¡</button>
        <div id="feedbackStatus" class="feedback-status"></div>
      </form>
    </div>
  </div>
</div>

</body>
</html>